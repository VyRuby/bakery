-- =====================================
-- RESET DATABASE
-- =====================================
DROP DATABASE IF EXISTS bakery_db;
CREATE DATABASE bakery_db;
USE bakery_db;

-- =====================================
-- EMPLOYEE
-- =====================================
CREATE TABLE EMPLOYEE (
    EmployeeID VARCHAR(10) PRIMARY KEY,
    FullName VARCHAR(100),
    DOB DATE,
    Gender ENUM('Male','Female'),
    Phone VARCHAR(20),
    Email VARCHAR(100) UNIQUE,
    Address VARCHAR(100),
    HireDate DATE,
    Position ENUM('Manager','Staff'),
    BaseDailySalary INT,
    Status ENUM('Active','Inactive')
);

-- =====================================
-- INSERT EMPLOYEE
-- =====================================
INSERT INTO EMPLOYEE VALUES
('E01','Nguyen Hong Ngoc','1998-01-10','Female','0901','a@gmail.com','HN','2001-01-01','Manager',500000,'Active'),
('E02','Tran Van Huy','1997-02-11','Male','0902','b@gmail.com','HCM','2020-05-12','Staff',300000,'Active'),
('E03','Pham Quoc Anh','2001-03-12','Male','0903','c@gmail.com','DN','2019-06-15','Staff',300000,'Active'),
('E04','Pham Thi D','1999-04-13','Female','0904','d@gmail.com','HN','2022-02-10','Staff',300000,'Active'),
('E05','Hoang Van E','1995-05-14','Male','0905','e@gmail.com','HCM','2018-03-20','Staff',300000,'Inactive'),
('E06','Nguyen Tu Quyen','2004-05-12','Female','0906','tuquyen@gmail.com','HN','2021-07-01','Staff',300000,'Active'),
('E07','Vu Van G','1997-07-16','Male','0907','g@gmail.com','HN','2020-08-08','Staff',300000,'Active'),
('E08','Dang Thi H','1996-08-17','Female','0908','h@gmail.com','HCM','2019-09-09','Staff',300000,'Active'),
('E09','Bui Van I','1995-09-18','Male','0909','i@gmail.com','DN','2018-10-10','Staff',300000,'Active'),
('E10','Nguyen Thi J','1999-10-19','Female','0910','j@gmail.com','HN','2022-11-11','Staff',300000,'Active');



DELIMITER $$

        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Check-in only allowed for today';
    END IF;

    SET NEW.IsLate = (NEW.CheckInTime > '08:00:00');
    SET NEW.IsEarlyLeave = 0;
END$$

-- =====================================
-- CHECKIN / CHECKOUT
-- =====================================
CREATE TABLE EMPLOYEE_CHECKIN (
    CheckInID INT AUTO_INCREMENT PRIMARY KEY,
    EmployeeID VARCHAR(10),
    WorkDate DATE,
    CheckInTime TIME,
    CheckOutTime TIME,
    IsLate BOOLEAN,
    IsEarlyLeave BOOLEAN,
    UNIQUE(EmployeeID, WorkDate),
    FOREIGN KEY (EmployeeID) REFERENCES EMPLOYEE(EmployeeID)
);
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Cannot modify past attendance records';
    END IF;

END$$

DELIMITER ;



CREATE TABLE `orderdetail` (
  `OrderDetailID` int(11) NOT NULL AUTO_INCREMENT,
  `OrderID` int(11) NOT NULL,
  `ProductID` varchar(30) NOT NULL,
  `Quantity` int(11) NOT NULL,
  `UnitPrice` decimal(12,2) NOT NULL,
  `CostPrice` decimal(12,2) NOT NULL,
  `PromoID` varchar(30) DEFAULT NULL,
  `DiscountAmount` decimal(12,2) DEFAULT 0.00
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

-- =====================================
-- PAYROLL
-- =====================================
CREATE TABLE EMPLOYEE_PAYROLL (
    EmployeeID VARCHAR(10),
    Month INT,
    Year INT,
    WorkDays INT DEFAULT 0,
    LateEarlyDays INT DEFAULT 0,
    Bonus INT DEFAULT 0,
    Penalty INT DEFAULT 0,
    TotalSalary INT DEFAULT 0,
    Locked BOOLEAN DEFAULT 0,
    PRIMARY KEY (EmployeeID, Month, Year)
);


CREATE TABLE `customer` (
  `CustomerID` int(10) NOT NULL AUTO_INCREMENT,
  `FullName` varchar(100) NOT NULL,
  `Phone` varchar(20) NOT NULL,
  `Gender` enum('Male','Female') NOT NULL,
  `DOB` date NOT NULL,
  `Email` varchar(100) DEFAULT NULL,
  `Address` varchar(255) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;



INSERT INTO `orders` (`OrderID`, `OrderDate`, `CustomerID`, `Total`, `PaymentMethod`) VALUES
(1, '2025-01-05 10:30:00', 1, 320000.00, 'Cash'),
(2, '2025-01-07 14:15:00', 4, 135000.00, 'Transfer'),
(3, '2025-01-10 09:00:00', 5, 240000.00, 'Cash'),
(4, '2025-01-12 16:45:00', 2, 100000.00, 'Transfer'),
(5, '2025-01-15 11:20:00', 8, 120000.00, 'Cash'),
(6, '2025-01-18 19:10:00', 10, 215000.00, 'Transfer'),
(7, '2025-01-20 08:30:00', 12, 48000.00, 'Cash'),
(8, '2025-01-22 15:00:00', 3, 160000.00, 'Cash'),
(9, '2025-01-25 13:00:00', 7, 76000.00, 'Transfer'),
(10, '2025-01-28 17:30:00', 13, 120000.00, 'Cash'),
(11, '2025-02-01 08:30:00', 3, 240000.00, 'Cash'),
(12, '2025-02-02 09:45:00', 3, 160000.00, 'Cash'),
(13, '2025-02-05 14:20:00', 1, 450000.00, 'Transfer'),
(14, '2025-02-07 10:10:00', 3, 70000.00, 'Cash'),
(15, '2025-02-10 16:00:00', 3, 135000.00, 'Cash'),
(16, '2025-02-12 11:30:00', 5, 120000.00, 'Transfer'),
(17, '2025-02-14 19:00:00', 3, 320000.00, 'Cash'),
(18, '2025-02-14 20:30:00', 3, 160000.00, 'Cash'),
(19, '2025-02-16 08:00:00', 3, 85000.00, 'Cash'),
(20, '2025-02-18 15:45:00', 2, 270000.00, 'Transfer'),
(21, '2025-02-20 12:00:00', 3, 55000.00, 'Cash'),
(22, '2025-02-22 13:20:00', 3, 120000.00, 'Cash'),
(23, '2025-02-25 10:00:00', 8, 240000.00, 'Transfer'),
(24, '2025-02-26 17:15:00', 3, 160000.00, 'Cash'),
(25, '2025-02-28 21:00:00', 3, 135000.00, 'Cash'),
(26, '2025-03-01 10:00:00', 3, 300000.00, 'Cash'),
(27, '2025-03-03 15:30:00', 7, 160000.00, 'Transfer'),
(28, '2025-03-07 09:15:00', 3, 480000.00, 'Cash'),
(29, '2025-03-08 11:00:00', 3, 320000.00, 'Cash'),
(30, '2025-03-08 16:45:00', 10, 270000.00, 'Transfer'),
(31, '2025-03-10 14:20:00', 3, 135000.00, 'Cash'),
(32, '2025-03-12 08:45:00', 5, 120000.00, 'Transfer'),
(33, '2025-03-15 13:10:00', 3, 100000.00, 'Cash'),
(34, '2025-03-18 17:30:00', 2, 240000.00, 'Transfer'),
(35, '2025-03-20 10:20:00', 3, 120000.00, 'Cash'),
(36, '2025-03-22 15:50:00', 12, 160000.00, 'Cash'),
(37, '2025-03-25 09:00:00', 3, 135000.00, 'Cash'),
(38, '2025-03-27 19:15:00', 3, 160000.00, 'Cash'),
(39, '2025-03-29 14:00:00', 8, 270000.00, 'Transfer'),
(40, '2025-03-31 20:30:00', 3, 85000.00, 'Cash'),
(41, '2025-04-02 09:00:00', 3, 120000.00, 'Cash'),
(42, '2025-04-05 14:20:00', 3, 160000.00, 'Cash'),
(43, '2025-04-08 10:30:00', 1, 270000.00, 'Transfer'),
(44, '2025-04-10 16:00:00', 3, 135000.00, 'Cash'),
(45, '2025-04-12 11:15:00', 12, 100000.00, 'Cash'),
(46, '2025-04-15 08:45:00', 3, 240000.00, 'Cash'),
(47, '2025-04-18 19:00:00', 3, 160000.00, 'Cash'),
(48, '2025-04-20 13:20:00', 5, 135000.00, 'Transfer'),
(49, '2025-04-22 15:00:00', 3, 76000.00, 'Cash'),
(50, '2025-04-25 10:00:00', 3, 160000.00, 'Cash'),
(51, '2025-04-28 17:30:00', 10, 320000.00, 'Transfer'),
(52, '2025-04-29 18:00:00', 3, 450000.00, 'Cash'),
(53, '2025-04-30 09:00:00', 3, 270000.00, 'Cash'),
(54, '2025-04-30 14:30:00', 3, 160000.00, 'Cash'),
(55, '2025-04-30 19:45:00', 2, 240000.00, 'Transfer'),
(56, '2025-05-02 10:00:00', 3, 160000.00, 'Cash'),
(57, '2025-05-05 15:30:00', 8, 240000.00, 'Transfer'),
(58, '2025-05-08 09:15:00', 3, 320000.00, 'Cash'),
(59, '2025-05-11 11:00:00', 3, 480000.00, 'Cash'),
(60, '2025-05-11 16:45:00', 5, 270000.00, 'Transfer'),
(61, '2025-05-14 14:20:00', 3, 135000.00, 'Cash'),
(62, '2025-05-16 08:45:00', 13, 120000.00, 'Cash'),
(63, '2025-05-19 13:10:00', 3, 160000.00, 'Cash'),
(64, '2025-05-21 17:30:00', 3, 240000.00, 'Cash'),
(65, '2025-05-23 10:20:00', 1, 135000.00, 'Transfer'),
(66, '2025-05-25 15:50:00', 3, 160000.00, 'Cash'),
(67, '2025-05-27 09:00:00', 3, 135000.00, 'Cash'),
(68, '2025-05-29 19:15:00', 12, 160000.00, 'Cash'),
(69, '2025-05-30 14:00:00', 3, 270000.00, 'Cash'),
(70, '2025-05-31 20:30:00', 3, 120000.00, 'Cash'),
(71, '2025-06-02 10:00:00', 3, 160000.00, 'Cash'),
(72, '2025-06-05 15:30:00', 3, 240000.00, 'Cash'),
(73, '2025-06-08 09:15:00', 5, 320000.00, 'Transfer'),
(74, '2025-06-12 11:00:00', 3, 480000.00, 'Cash'),
(75, '2025-06-15 16:45:00', 3, 270000.00, 'Cash'),
(76, '2025-06-18 14:20:00', 1, 135000.00, 'Transfer'),
(77, '2025-06-21 08:45:00', 3, 120000.00, 'Cash'),
(78, '2025-06-23 13:10:00', 3, 160000.00, 'Cash'),
(79, '2025-06-25 17:30:00', 3, 240000.00, 'Cash'),
(80, '2025-06-26 10:20:00', 12, 135000.00, 'Cash'),
(81, '2025-06-27 15:50:00', 3, 160000.00, 'Cash'),
(82, '2025-06-28 09:00:00', 3, 135000.00, 'Cash'),
(83, '2025-06-29 19:15:00', 3, 160000.00, 'Cash'),
(84, '2025-06-30 14:00:00', 7, 270000.00, 'Transfer'),
(85, '2025-06-30 20:30:00', 3, 120000.00, 'Cash'),
(86, '2025-07-02 09:30:00', 3, 320000.00, 'Cash'),
(87, '2025-07-04 14:15:00', 3, 160000.00, 'Cash'),
(88, '2025-07-07 10:00:00', 3, 135000.00, 'Cash'),
(89, '2025-07-10 16:45:00', 3, 240000.00, 'Cash'),
(90, '2025-07-12 11:20:00', 2, 450000.00, 'Transfer'),
(91, '2025-07-15 08:30:00', 3, 120000.00, 'Cash'),
(92, '2025-07-18 19:10:00', 3, 270000.00, 'Cash'),
(93, '2025-07-20 13:00:00', 3, 160000.00, 'Cash'),
(94, '2025-07-22 15:45:00', 8, 135000.00, 'Transfer'),
(95, '2025-07-25 10:00:00', 3, 320000.00, 'Cash'),
(96, '2025-07-26 17:30:00', 3, 160000.00, 'Cash'),
(97, '2025-07-28 18:00:00', 10, 240000.00, 'Transfer'),
(98, '2025-07-29 09:00:00', 3, 135000.00, 'Cash'),
(99, '2025-07-30 14:30:00', 3, 160000.00, 'Cash'),
(100, '2025-07-31 19:45:00', 3, 270000.00, 'Cash'),
(101, '2025-08-02 10:00:00', 3, 120000.00, 'Cash'),
(102, '2025-08-05 15:30:00', 3, 160000.00, 'Cash'),
(103, '2025-08-08 09:15:00', 5, 270000.00, 'Transfer'),
(104, '2025-08-11 11:00:00', 3, 135000.00, 'Cash'),
(105, '2025-08-14 16:45:00', 1, 100000.00, 'Transfer'),
(106, '2025-08-16 14:20:00', 3, 240000.00, 'Cash'),
(107, '2025-08-18 08:45:00', 3, 160000.00, 'Cash'),
(108, '2025-08-20 13:10:00', 3, 135000.00, 'Cash'),
(109, '2025-08-22 17:30:00', 12, 76000.00, 'Cash'),
(110, '2025-08-24 10:20:00', 3, 160000.00, 'Cash'),
(111, '2025-08-25 15:50:00', 3, 320000.00, 'Cash'),
(112, '2025-08-27 09:00:00', 3, 135000.00, 'Cash'),
(113, '2025-08-28 19:15:00', 13, 160000.00, 'Cash'),
(114, '2025-08-30 14:00:00', 3, 270000.00, 'Cash'),
(115, '2025-08-31 20:30:00', 3, 120000.00, 'Cash'),
(116, '2025-09-05 10:00:00', 3, 320000.00, 'Cash'),
(117, '2025-09-10 15:30:00', 3, 450000.00, 'Cash'),
(118, '2025-09-15 09:15:00', 5, 270000.00, 'Transfer'),
(119, '2025-09-20 11:00:00', 3, 160000.00, 'Cash'),
(120, '2025-09-25 16:45:00', 3, 135000.00, 'Cash'),
(121, '2025-09-28 14:20:00', 1, 320000.00, 'Transfer'),
(122, '2025-09-30 08:45:00', 3, 160000.00, 'Cash'),
(123, '2025-10-05 13:10:00', 3, 240000.00, 'Cash'),
(124, '2025-10-12 17:30:00', 12, 120000.00, 'Cash'),
(125, '2025-10-15 10:20:00', 3, 160000.00, 'Cash'),
(126, '2025-10-20 15:50:00', 3, 270000.00, 'Cash'),
(127, '2025-10-25 09:00:00', 3, 135000.00, 'Cash'),
(128, '2025-10-30 19:15:00', 3, 450000.00, 'Cash'),
(129, '2025-10-31 20:00:00', 3, 320000.00, 'Cash'),
(130, '2025-11-05 14:00:00', 7, 240000.00, 'Transfer'),
(131, '2025-11-10 10:30:00', 3, 160000.00, 'Cash'),
(132, '2025-11-15 16:00:00', 3, 135000.00, 'Cash'),
(133, '2025-11-20 09:45:00', 2, 270000.00, 'Transfer'),
(134, '2025-11-25 11:20:00', 3, 160000.00, 'Cash'),
(135, '2025-11-28 19:10:00', 3, 120000.00, 'Cash'),
(136, '2025-12-05 08:30:00', 3, 480000.00, 'Cash'),
(137, '2025-12-10 13:00:00', 8, 320000.00, 'Transfer'),
(138, '2025-12-15 15:45:00', 3, 160000.00, 'Cash'),
(139, '2025-12-20 10:00:00', 3, 450000.00, 'Cash'),
(140, '2025-12-24 18:00:00', 3, 640000.00, 'Cash'),
(141, '2025-12-25 11:00:00', 3, 320000.00, 'Cash'),
(142, '2025-12-28 14:30:00', 10, 270000.00, 'Transfer'),
(143, '2025-12-30 19:45:00', 3, 160000.00, 'Cash'),
(144, '2025-12-31 21:00:00', 3, 480000.00, 'Cash');

-- =====================================
-- ATTENDANCE LOG
-- =====================================
CREATE TABLE EMPLOYEE_ATTENDANCE_LOG (
    LogID INT AUTO_INCREMENT PRIMARY KEY,
    EmployeeID VARCHAR(10),
    WorkDate DATE,
    Action ENUM('CHECKIN','CHECKOUT'),
    ActionTime DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- =====================================
-- TRIGGER: CHECKIN VALIDATION (REALTIME + BATCH)
-- =====================================

-- Xem thông tin cơ bản
GRANT SELECT ON bakery_db.EMPLOYEE TO 'b@gmail.com'@'localhost';

-- Attendance / Check-in
GRANT SELECT ON bakery_db.EMPLOYEE_CHECKIN TO 'b@gmail.com'@'localhost';
GRANT SELECT ON bakery_db.EMPLOYEE_ATTENDANCE_LOG TO 'b@gmail.com'@'localhost';



ALTER TABLE PRODUCT
ADD CONSTRAINT uq_product_name UNIQUE (ProductName);
